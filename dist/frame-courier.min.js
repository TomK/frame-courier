!function(){"use strict";function e(e,t,r){var n,o,i,a,u;function s(){var c=Date.now()-a;c<t&&c>=0?n=setTimeout(s,t-c):(n=null,r||(u=e.apply(i,o),i=o=null))}null==t&&(t=100);var c=function(){i=this,o=arguments,a=Date.now();var c=r&&!n;return n||(n=setTimeout(s,t)),c&&(u=e.apply(i,o),i=o=null),u};return c.clear=function(){n&&(clearTimeout(n),n=null)},c.flush=function(){n&&(u=e.apply(i,o),i=o=null,clearTimeout(n),n=null)},c}e.debounce=e;var t=e;function r(e,t){var r,n;if(0===t.length)return e;for(r=0,n=t.length;r<n;r++)e=(e<<5)-e+t.charCodeAt(r),e|=0;return e<0?-2*e:e}function n(e,t,o,i){var a,u=r(r(r(e,o),(a=t,Object.prototype.toString.call(a))),typeof t);if(null===t)return r(u,"null");if(void 0===t)return r(u,"undefined");if("object"==typeof t||"function"==typeof t){if(-1!==i.indexOf(t))return r(u,"[Circular]"+o);i.push(t);var s=function(e,t,r){return Object.keys(t).sort().reduce((function(e,o){return n(e,t[o],o,r)}),e)}(u,t,i);if(!("valueOf"in t)||"function"!=typeof t.valueOf)return s;try{return r(s,String(t.valueOf()))}catch(e){return r(s,"[valueOf exception]"+(e.stack||e.message))}}return r(u,t.toString())}var o=function(e){return function(e,t){for(;e.length<t;)e="0"+e;return e}(n(0,e,"",[]).toString(16),8)},i=("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{}).CustomEvent;var a=function(){try{var e=new i("cat",{detail:{foo:"bar"}});return"cat"===e.type&&"bar"===e.detail.foo}catch(e){}return!1}()?i:"undefined"!=typeof document&&"function"==typeof document.createEvent?function(e,t){var r=document.createEvent("CustomEvent");return t?r.initCustomEvent(e,t.bubbles,t.cancelable,t.detail):r.initCustomEvent(e,!1,!1,void 0),r}:function(e,t){var r=document.createEventObject();return r.type=e,t?(r.bubbles=Boolean(t.bubbles),r.cancelable=Boolean(t.cancelable),r.detail=t.detail):(r.bubbles=!1,r.cancelable=!1,r.detail=void 0),r};!function(e){if(!e.origin){var t=e.protocol+"//"+e.hostname+(e.port&&":"+e.port);try{Object.defineProperty(e,"origin",{enumerable:!0,value:t})}catch(r){e.origin=t}}}(window.location);class u{static fromObject(e){return Object.setPrototypeOf(e,this.prototype)}constructor(e,t,r,n){"string"==typeof(t=t||[])?t=t.split(/\s+/):Array.isArray(t)||(console.warn("invalid tags for frame",{id:e,tags:t}),t=[]),this._id=e,this._tags="string"==typeof t?t.split(/\s+/):t,this._frameNumber=r,this._origin=n}get id(){return this._id}get tags(){return this._tags}get frameNumber(){return this._frameNumber}setFrameNumber(e){return this._frameNumber=e,this}setOrigin(e){return this._origin=e,this}get origin(){return this._origin}}let s=null,c={};const f={LOADED:"_frame_courier--loaded",PROBE:"_frame_courier--probe",READY:"_frame_courier--ready",MESSAGE_RESPONSE:"_frame_courier--message-response"},l={};function d(e){if(!c[e.id])return c[e.id]=e,e;console.warn("cannot add two frames with the same id")}function m(e,t,r,n){return n=n||null,{messageId:e+":"+o(Date.now()+t+n),event:e,to:t,toOrigin:r,from:s,fromOrigin:window.location.origin,payload:JSON.stringify(n)}}function g(e,t,r,n,o){const i=c[e];if(!i)throw{message:"frame does not exist",data:e};if(o&&o!==i.origin)throw{message:"target origin does not match",data:e};{const o=m(t,e,i.origin,r),a=i.frameNumber<0?window.top:window.top.frames[i.frameNumber];if(!a)throw{message:"target window is not accessible",data:e};h(a,i.origin,o,n)}}function b(e,t,r,n){Object.values(c).forEach(o=>{o.id!==s&&g(o.id,e,t,r,n)})}function h(e,t,r,n){n&&p(w(r.messageId),n),e.postMessage(JSON.stringify(r),t)}function p(e,t){l.hasOwnProperty(e)||(l[e]=[]),l[e].push(t)}function w(e){return f.MESSAGE_RESPONSE+":"+o(e)}if(window.addEventListener("message",e=>{if(e.data){let t;try{t=JSON.parse(e.data)}catch(e){return}if(["event","to","toOrigin","from","fromOrigin","payload"].every(e=>t.hasOwnProperty(e))&&!("*"!==t.toOrigin&&t.toOrigin!==window.location.origin||null!==s&&s!==t.to)){const r=JSON.parse(t.payload);if(l.hasOwnProperty(t.event)){const n=(r,n)=>{const o=m(w(t.messageId),t.from,t.fromOrigin,r);h(e.source,e.origin,o,n)};l[t.event].forEach(t=>{t(r,n,e.source,e.origin)})}}}}),window===window.top){s="",d(new u("",[],-1,window.location.origin)),window.MutationObserver?new MutationObserver(e=>{e.forEach(e=>{Array.from(e.removedNodes).filter(e=>e.nodeType===Node.ELEMENT_NODE).forEach(e=>{y(e.matches("iframe")?[e]:e.querySelectorAll("iframe"))})})}).observe(document,{subtree:!0,childList:!0}):document.addEventListener("DOMNodeRemoved",(function(e){e.target.nodeType===Node.ELEMENT_NODE&&y(e.target.matches("iframe")?[e.target]:e.target.querySelectorAll("iframe"))}));const e=t((function(){document.querySelectorAll("iframe").forEach(e=>O(e));const e=o(JSON.stringify(c));Object.keys(c).filter(e=>c[e].origin).forEach(t=>{g(t,f.PROBE,"hello "+e,(r,n)=>{r==="send "+e&&n({frameId:t,frames:c})})})}),10);function y(t){t.length&&(t.forEach(e=>{if(e.hasAttribute("courier-id")){const t=e.getAttribute("courier-id");t&&c[t]&&delete c[t]}}),e())}function O(e,t){if(!e.hasAttribute("courier-id")){if(!t)return;e.setAttribute("courier-id","frame-"+parseInt(Math.random().toFixed(16).slice(2,19)).toString(36))}const r=e.getAttribute("courier-id"),n=e.getAttribute("courier-tags"),o=function(e){for(let t=0;t<window.frames.length;t++)if(e.contentWindow===window.frames[t])return t;return!1}(e),i=c[r];i?(i.setFrameNumber(o),t&&i.setOrigin(t)):d(new u(r,n,o,t))}p(f.LOADED,(t,r,n,o)=>{document.querySelectorAll("iframe").forEach(e=>{e.contentWindow===n&&O(e,o)}),e()})}else{h(window.top,"*",m(f.LOADED,"","*","hello"));let e=!1;p(f.PROBE,(t,r)=>{const n=o(JSON.stringify(c)),i=t.split(" ",2);n!==i[1]&&r("send "+i[1],t=>{s=t.frameId,Object.values(t.frames).map(e=>u.fromObject(e)),c=t.frames,e||(e=!0,document.dispatchEvent(new a("frame-courier-ready",{detail:{frameId:s}})),b(f.READY,s))})})}const v={send:g,sendToTag:function(e,t,r,n,o){Object.values(c).forEach(i=>{i.tags.indexOf(e)>-1&&g(i.id,t,r,n,o)})},broadcast:b,id:function(){return s},tags:function(){return c[s].tags},listen:p,events:f,frames:c};window.FrameCourier=v}();
